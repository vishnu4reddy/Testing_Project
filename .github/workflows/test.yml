name: Test Automation Image

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        type: choice
        required: True
        options:
          - mira
          - polaris
          - pavo
          - hoku
      test_component:
        description: 'Components to run tests with'
        required: True
        default: 'all'
        type: choice
        options:
          - acct_mgmt
          - authz
          - notifications
          - support_assistent
          - ups
          - unified
          - sam
          - all
      marker:
        description: 'The pytest marker to filter tests (e.g., "Plv")'
        required: True
        default: 'all'
        type: choice
        options:
          - all
          - Regression
          - Plv

env:
  image_registry: quay.io
  quay_username: ${{ secrets.CCS_QUAY_CCSPORTAL_BUILDER }}
  quay_password: ${{ secrets.CCS_QUAY_CCSPORTAL_BUILDER_PASSWORD }}
  image_name: auto-login-functionals
  version: "2.0"

jobs:
  Trigger_Manual_Dev_Build:
    runs-on: ubuntu-latest
    name: Trigger Manual Dev Build Workflow
    steps:
      - name: Trigger Manual Dev Build with Current Branch
        run: |
          # Extract the branch name from the ref (e.g., "refs/heads/branch-name")
          BRANCH_NAME=${GITHUB_REF##*/}

          curl -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -d '{"ref": "${BRANCH_NAME}"}' \
            https://api.github.com/repos/<owner>/<repo>/actions/workflows/manual_dev_build.yml/dispatches


  Docker_Image_Pull:
    needs: Trigger_Manual_Dev_Build
    runs-on: ubuntu-latest
    name: Pull the Docker Image
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Docker Login (if needed)
        run: |
          echo ${{ secrets.CCS_QUAY_CCSPORTAL_BUILDER_PASSWORD }} | docker login quay.io -u ${{ secrets.CCS_QUAY_CCSPORTAL_BUILDER }} --password-stdin

      - name: Pull Docker Image
        run: |
          docker pull ${{ env.image_registry }}/${{ env.image_name }}:${{ github.sha }}

  Run_Tests_In_Container:
    needs: Docker_Image_Pull
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: ${{ github.event.inputs.test_component == 'all' && 'acct_mgmt,authz,notifications,support_assistent,ups,unified,sam' || github.event.inputs.test_component }}
    name: Run Tests for ${{ matrix.component }}
    env:
      COMPONENT_PATH: ${{ matrix.component == 'acct_mgmt' && 'path/to/acct_mgmt' ||
                          matrix.component == 'authz' && 'path/to/authz' ||
                          matrix.component == 'notifications' && 'path/to/notifications' ||
                          matrix.component == 'support_assistent' && 'path/to/support_assistent' ||
                          matrix.component == 'ups' && 'path/to/ups' ||
                          matrix.component == 'unified' && 'path/to/unified' ||
                          matrix.component == 'sam' && 'path/to/sam' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Tests in Docker Container for ${{ matrix.component }}
        run: |
          docker run --rm \
            -e ENVIRONMENT=${{ github.event.inputs.environment }} \
            -e TEST_COMPONENT=${{ matrix.component }} \
            -e MARKER=${{ github.event.inputs.marker }} \
            -e COMPONENT_PATH=${{ env.COMPONENT_PATH }} \
            ${{ env.image_registry }}/${{ env.image_name }}:${{ github.sha }} \
            pytest --path ${{ env.COMPONENT_PATH }} --marker ${{ github.event.inputs.marker }} --component ${{ matrix.component }} --env ${{ github.event.inputs.environment }}

      - name: Uploading Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report